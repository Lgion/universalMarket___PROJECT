<!DOCTYPE html>
<html>
<head>
    <title>Supermarché Virtual - Vue Simple</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="avatar.js"></script>
    <script src="cart.js"></script>
    <script>
        let scene, camera, renderer;
        let playerGroup;
        let rotationSpeed = 0.1;
        let moveSpeed = 0.2;
        let currentRotation = 0;
        let targetRotation = 0;
        let isRotating = false;
        let isWalking = false;

        function init() {
            // Scène de base
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Caméra
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0); // Hauteur moyenne d'un humain
            camera.lookAt(0, 1.6, -5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Éclairage
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            scene.add(directionalLight);

            // Sol
            const floorGeometry = new THREE.PlaneGeometry(20, 50);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xcccccc,
                roughness: 0.8
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Groupe pour l'avatar et le caddie
            playerGroup = new THREE.Group();

            // Avatar (représenté par un cylindre simple)
            const avatar = new Avatar();
            playerGroup.add(avatar);
            scene.add(playerGroup);

            const cart = new ShoppingCart();
            cart.position.z = 0.7; // Positionner le caddie derrière l'avatar
            playerGroup.add(cart);

            // Rayons (têtes de gondole)
            const aisleGeometry = new THREE.BoxGeometry(3, 4, 2);
            const aisleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x666666,
                roughness: 0.7
            });

            // Création des rayons de chaque côté
            for(let z = -20; z <= 20; z += 5) {
                // Rayon gauche
                const leftAisle = new THREE.Mesh(aisleGeometry, aisleMaterial);
                leftAisle.position.set(-8, 2, z);
                scene.add(leftAisle);

                // Rayon droit
                const rightAisle = new THREE.Mesh(aisleGeometry, aisleMaterial);
                rightAisle.position.set(8, 2, z);
                scene.add(rightAisle);
            }

            playerGroup.rotation.y = Math.PI; // Oriente l'ensemble vers le fond du magasin
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRotating) {
                // Animation douce de la rotation
                const rotationDiff = targetRotation - currentRotation;
                if (Math.abs(rotationDiff) > 0.01) {
                    currentRotation += rotationDiff * 0.1;
                    playerGroup.rotation.y = currentRotation;
                    
                    // Mise à jour de la caméra pour la vue FPS
                    camera.position.x = playerGroup.position.x;
                    camera.position.z = playerGroup.position.z;
                    camera.position.y = 1.6; // Hauteur des yeux

                    const lookAtPoint = new THREE.Vector3(
                        playerGroup.position.x - Math.sin(currentRotation) * 5,
                        1.6,
                        playerGroup.position.z - Math.cos(currentRotation) * 5
                    );
                    camera.lookAt(lookAtPoint);
                } else {
                    isRotating = false;
                    currentRotation = targetRotation;
                }
            }

            renderer.render(scene, camera);
        }

        // Contrôles basiques
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case 'ArrowUp':
                case 'z':
                    isWalking = true;
                    playerGroup.position.z -= moveSpeed; // Avance vers le fond (-Z)
                    updateCameraPosition();
                    break;
                case 'ArrowDown':
                case 's':
                    isWalking = true;
                    playerGroup.position.z += moveSpeed; // Recule vers l'avant (+Z)
                    updateCameraPosition();
                    break;
                case 'ArrowLeft':
                case 'q':
                    // Rotation de la tête vers la gauche
                    isRotating = true;
                    targetRotation = Math.PI / 2;
                    break;
                case 'ArrowRight':
                case 'd':
                    // Rotation de la tête vers la droite
                    isRotating = true;
                    targetRotation = -Math.PI / 2;
                    break;
            }
        });

        document.addEventListener('keyup', (event) => {
            if (['ArrowLeft', 'ArrowRight', 'q', 'd'].includes(event.key)) {
                // Retour à la position centrale quand on relâche
                isRotating = true;
                targetRotation = 0;
            }
        });

        // Gestion du redimensionnement
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
        animate();
    </script>
</body>
</html>
